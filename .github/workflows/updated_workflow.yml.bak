name: immortalwrt-all

on:
  watch:
    types: [ started ]
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: false
        type: boolean
      CACHE_BUILD:
        description: 'ç¼“å­˜åŠ é€Ÿ'
        required: true
        default: true
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'æ˜¯å¦ä¸Šä¼ å›ºä»¶'
        required: true
        default: true
        type: boolean
      UPLOAD_BUILDINFO:
        description: 'æ˜¯å¦ä¸Šä¼ é…ç½®æ–‡ä»¶'
        required: true
        default: true
        type: boolean

    steps:
    - name: å®‰è£…æºå’Œä¿®æ”¹é»˜è®¤è®¾ç½®
          run: |
            cd openwrt
            ./scripts/feeds install -a
            echo "=== å¼€å§‹ä¿®æ”¹é»˜è®¤è®¾ç½®æ–‡ä»¶ ==="
            # æŸ¥æ‰¾default-settingsç›®å½•
            DEFAULT_SETTINGS_PATH=""
            if [ -d "package/emortal/default-settings" ]; then
              DEFAULT_SETTINGS_PATH="package/emortal/default-settings"
            elif [ -d "package/lean/default-settings" ]; then
              DEFAULT_SETTINGS_PATH="package/lean/default-settings"
            else
              echo "æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„default-settingsç›®å½•:"
              find package/ -name "*default*" -type d
              DEFAULT_SETTINGS_PATH=$(find package/ -name "*default*" -type d | head -1)
            fi
            if [ -z "$DEFAULT_SETTINGS_PATH" ]; then
              echo "é”™è¯¯: æœªæ‰¾åˆ°default-settingsç›®å½•"
              exit 1
            fi
            echo "ä½¿ç”¨ç›®å½•: $DEFAULT_SETTINGS_PATH"
            cd $DEFAULT_SETTINGS_PATH
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨99-default-settingsæ–‡ä»¶
            if [ -f "files/99-default-settings" ]; then
              echo "âœ“ æ‰¾åˆ°99-default-settingsæ–‡ä»¶"
              # å¤‡ä»½åŸæ–‡ä»¶
              cp files/99-default-settings files/99-default-settings.bak
              echo "âœ“ å·²å¤‡ä»½åŸæ–‡ä»¶"
              # æ–¹æ³•1: ä½¿ç”¨patchæ–¹å¼ä¿®æ”¹ï¼ˆå¦‚æœå­˜åœ¨patchæ–‡ä»¶ï¼‰
              if [ -e "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ]; then
                echo "å°è¯•ä½¿ç”¨patchæ–¹å¼ä¿®æ”¹..."
                cp "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ./settings.patch
                if patch --dry-run -p1 < settings.patch >/dev/null 2>&1; then
                  patch -p1 < settings.patch
                  echo "âœ“ patchæ–¹å¼ä¿®æ”¹æˆåŠŸ"
                else
                  echo "âš  patchæ–¹å¼å¤±è´¥ï¼Œä½¿ç”¨sedæ–¹å¼ä¿®æ”¹"
                  # æ¢å¤å¤‡ä»½æ–‡ä»¶
                  cp files/99-default-settings.bak files/99-default-settings
                fi
              fi
              # æ–¹æ³•2: ä½¿ç”¨sedç›´æ¥åœ¨exit 0ä¹‹å‰æ’å…¥å†…å®¹
              if ! grep -q "ImmortalWrt-Custom" files/99-default-settings; then
                echo "ä½¿ç”¨sedæ–¹å¼æ·»åŠ è‡ªå®šä¹‰è®¾ç½®..."
                # åˆ›å»ºä¸´æ—¶çš„è‡ªå®šä¹‰è®¾ç½®å†…å®¹
                cat > /tmp/custom_settings << 'EOF'
    # === è‡ªå®šä¹‰è®¾ç½®å¼€å§‹ ===
    echo "åº”ç”¨è‡ªå®šä¹‰é»˜è®¤è®¾ç½®..."
    # ç³»ç»Ÿè®¾ç½®
    uci set system.@system[0].hostname='ImmortalWrt-Custom'
    uci set system.@system[0].timezone='CST-8'
    uci set system.@system[0].zonename='Asia/Shanghai'
    # ç½‘ç»œè®¾ç½®
    uci set network.lan.ipaddr='192.168.10.1'
    uci set network.lan.netmask='255.255.255.0'
    # DHCPè®¾ç½®
    uci set dhcp.lan.start='100'
    uci set dhcp.lan.limit='150'
    uci set dhcp.lan.leasetime='12h'
    # åˆ é™¤IPv6è®¾ç½®
    uci delete network.lan.ip6assign 2>/dev/null
    uci delete network.wan6 2>/dev/null
    uci delete dhcp.lan.dhcpv6 2>/dev/null
    uci delete dhcp.lan.ra 2>/dev/null
    # è®¾ç½®é»˜è®¤å¯†ç 
    echo 'root:password' | chpasswd
    # NTPæœåŠ¡å™¨è®¾ç½®
    uci delete system.ntp.server 2>/dev/null
    uci add_list system.ntp.server='ntp.aliyun.com'
    uci add_list system.ntp.server='time.pool.aliyun.com'
    uci add_list system.ntp.server='cn.pool.ntp.org'
    # æ— çº¿è®¾ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          find package/ -name "*default*" -type d
          DEFAULT_SETTINGS_PATH=$(find package/ -name "*default*" -type d | head -1)
        uci set wireless.$wifi_device.disabled='0'
        uci set wireless.$wifi_device.country='CN'
        uci set wireless.$wifi_device.channel='auto'
        wifi_iface=$(uci show wireless 2>/dev/null | grep "wireless\.default_" | cut -d'.' -f2 | cut -d'=' -f1 | head -1)
        if [ -n "$wifi_iface" ]; then
            uci set wireless.$wifi_iface.ssid='ImmortalWrt-WiFi'
            uci set wireless.$wifi_iface.key='12345678'
            uci set wireless.$wifi_iface.encryption='psk2'
            uci set wireless.$wifi_iface.disabled='0'
        fi
    fi
    echo "è‡ªå®šä¹‰è®¾ç½®åº”ç”¨å®Œæˆ"
    # === è‡ªå®šä¹‰è®¾ç½®ç»“æŸ ===
    EOF
                # åœ¨exit 0ä¹‹å‰æ’å…¥è‡ªå®šä¹‰å†…å®¹
                if grep -q "exit 0" files/99-default-settings; then
                  sed -i '/exit 0/i\# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===' files/99-default-settings
                  sed -i '/# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===/r /tmp/custom_settings' files/99-default-settings
                  sed -i '/# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===/d' files/99-default-settings
                  echo "âœ“ ä½¿ç”¨sedæ–¹å¼ä¿®æ”¹æˆåŠŸ"
                else
                  cat /tmp/custom_settings >> files/99-default-settings
                  echo "exit 0" >> files/99-default-settings
                  echo "âœ“ åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ è‡ªå®šä¹‰è®¾ç½®"
                fi
                rm -f /tmp/custom_settings
              else
                echo "â„¹ æ–‡ä»¶å·²åŒ…å«è‡ªå®šä¹‰è®¾ç½®ï¼Œè·³è¿‡ä¿®æ”¹"
              fi
              chmod +x files/99-default-settings
            else
              echo "âš  æœªæ‰¾åˆ°99-default-settingsæ–‡ä»¶ï¼Œåˆ—å‡ºfilesç›®å½•å†…å®¹:"
              ls -la files/ 2>/dev/null || echo "filesç›®å½•ä¸å­˜åœ¨"
            fi
            echo "=== ä¿®æ”¹å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶å†…å®¹ ==="
            if [ -f "files/99-default-settings" ]; then
              echo "æ–‡ä»¶å†…å®¹:"
              cat files/99-default-settings
            fi
        fi
        
        if [ -z "$DEFAULT_SETTINGS_PATH" ]; then
          echo "é”™è¯¯: æœªæ‰¾åˆ°default-settingsç›®å½•"
          exit 1
        fi
        
        echo "ä½¿ç”¨ç›®å½•: $DEFAULT_SETTINGS_PATH"
        cd $DEFAULT_SETTINGS_PATH
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨99-default-settingsæ–‡ä»¶
        if [ -f "files/99-default-settings" ]; then
          echo "âœ“ æ‰¾åˆ°99-default-settingsæ–‡ä»¶"
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp files/99-default-settings files/99-default-settings.bak
          echo "âœ“ å·²å¤‡ä»½åŸæ–‡ä»¶"
          
          # æ–¹æ³•1: ä½¿ç”¨patchæ–¹å¼ä¿®æ”¹ï¼ˆå¦‚æœå­˜åœ¨patchæ–‡ä»¶ï¼‰
          if [ -e "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ]; then
            echo "å°è¯•ä½¿ç”¨patchæ–¹å¼ä¿®æ”¹..."
            cp "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ./settings.patch
            
            if patch --dry-run -p1 < settings.patch >/dev/null 2>&1; then
              patch -p1 < settings.patch
              echo "âœ“ patchæ–¹å¼ä¿®æ”¹æˆåŠŸ"
            else
              echo "âš  patchæ–¹å¼å¤±è´¥ï¼Œä½¿ç”¨sedæ–¹å¼ä¿®æ”¹"
              # æ¢å¤å¤‡ä»½æ–‡ä»¶
              cp files/99-default-settings.bak files/99-default-settings
            fi
          fi
          
          # æ–¹æ³•2: ä½¿ç”¨sedç›´æ¥åœ¨exit 0ä¹‹å‰æ’å…¥å†…å®¹
          if ! grep -q "ImmortalWrt-Custom" files/99-default-settings; then
            echo "ä½¿ç”¨sedæ–¹å¼æ·»åŠ è‡ªå®šä¹‰è®¾ç½®..."
            
            # åˆ›å»ºä¸´æ—¶çš„è‡ªå®šä¹‰è®¾ç½®å†…å®¹
            cat > /tmp/custom_settings << 'EOF'

# === è‡ªå®šä¹‰è®¾ç½®å¼€å§‹ ===
echo "åº”ç”¨è‡ªå®šä¹‰é»˜è®¤è®¾ç½®..."

# ç³»ç»Ÿè®¾ç½®
uci set system.@system[0].hostname='ImmortalWrt-Custom'
uci set system.@system[0].timezone='CST-8'
uci set system.@system[0].zonename='Asia/Shanghai'

# ç½‘ç»œè®¾ç½®
uci set network.lan.ipaddr='192.168.10.1'
uci set network.lan.netmask='255.255.255.0'

# DHCPè®¾ç½®
uci set dhcp.lan.start='100'
uci set dhcp.lan.limit='150'
uci set dhcp.lan.leasetime='12h'

# åˆ é™¤IPv6è®¾ç½®
uci delete network.lan.ip6assign 2>/dev/null
uci delete network.wan6 2>/dev/null
uci delete dhcp.lan.dhcpv6 2>/dev/null
uci delete dhcp.lan.ra 2>/dev/null

# è®¾ç½®é»˜è®¤å¯†ç 
echo 'root:password' | chpasswd

# NTPæœåŠ¡å™¨è®¾ç½®
uci delete system.ntp.server 2>/dev/null
uci add_list system.ntp.server='ntp.aliyun.com'
uci add_list system.ntp.server='time.pool.aliyun.com'
uci add_list system.ntp.server='cn.pool.ntp.org'

# æ— çº¿è®¾ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
wifi_device=$(uci show wireless 2>/dev/null | grep "wireless\.radio" | cut -d'.' -f2 | cut -d'=' -f1 | head -1)
if [ -n "$wifi_device" ]; then
    uci set wireless.$wifi_device.disabled='0'
    uci set wireless.$wifi_device.country='CN'
    uci set wireless.$wifi_device.channel='auto'
    
    wifi_iface=$(uci show wireless 2>/dev/null | grep "wireless\.default_" | cut -d'.' -f2 | cut -d'=' -f1 | head -1)
    if [ -n "$wifi_iface" ]; then
        uci set wireless.$wifi_iface.ssid='ImmortalWrt-WiFi'
        uci set wireless.$wifi_iface.key='12345678'
        uci set wireless.$wifi_iface.encryption='psk2'
        uci set wireless.$wifi_iface.disabled='0'
    fi
fi

echo "è‡ªå®šä¹‰è®¾ç½®åº”ç”¨å®Œæˆ"
# === è‡ªå®šä¹‰è®¾ç½®ç»“æŸ ===

EOF
            
            # åœ¨exit 0ä¹‹å‰æ’å…¥è‡ªå®šä¹‰å†…å®¹
            if grep -q "exit 0" files/99-default-settings; then
              # æ‰¾åˆ°exit 0çš„è¡Œå·ï¼Œåœ¨å…¶å‰é¢æ’å…¥å†…å®¹
              sed -i '/exit 0/i\
          if ! grep -q "ImmortalWrt-Custom" files/99-default-settings; then
            echo "ä½¿ç”¨sedæ–¹å¼æ·»åŠ è‡ªå®šä¹‰è®¾ç½®..."
            # åˆ›å»ºä¸´æ—¶çš„è‡ªå®šä¹‰è®¾ç½®å†…å®¹
            cat > /tmp/custom_settings << 'EOF'
# === è‡ªå®šä¹‰è®¾ç½®å¼€å§‹ ===
echo "åº”ç”¨è‡ªå®šä¹‰é»˜è®¤è®¾ç½®..."
# ç³»ç»Ÿè®¾ç½®
uci set system.@system[0].hostname='ImmortalWrt-Custom'
uci set system.@system[0].timezone='CST-8'
uci set system.@system[0].zonename='Asia/Shanghai'
# ç½‘ç»œè®¾ç½®
uci set network.lan.ipaddr='192.168.10.1'
uci set network.lan.netmask='255.255.255.0'
# DHCPè®¾ç½®
uci set dhcp.lan.start='100'
uci set dhcp.lan.limit='150'
uci set dhcp.lan.leasetime='12h'
# åˆ é™¤IPv6è®¾ç½®
uci delete network.lan.ip6assign 2>/dev/null
uci delete network.wan6 2>/dev/null
uci delete dhcp.lan.dhcpv6 2>/dev/null
uci delete dhcp.lan.ra 2>/dev/null
# è®¾ç½®é»˜è®¤å¯†ç 
echo 'root:password' | chpasswd
# NTPæœåŠ¡å™¨è®¾ç½®
uci delete system.ntp.server 2>/dev/null
uci add_list system.ntp.server='ntp.aliyun.com'
uci add_list system.ntp.server='time.pool.aliyun.com'
uci add_list system.ntp.server='cn.pool.ntp.org'
# æ— çº¿è®¾ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # åç»­çš„ä¸Šä¼ å’Œå‘å¸ƒæ­¥éª¤ä¿æŒä¸å˜...
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: artifact
      if: steps.compile.outputs.status == 'success' && !cancelled()
echo "è‡ªå®šä¹‰è®¾ç½®åº”ç”¨å®Œæˆ"
# === è‡ªå®šä¹‰è®¾ç½®ç»“æŸ ===
EOF
            # åœ¨exit 0ä¹‹å‰æ’å…¥è‡ªå®šä¹‰å†…å®¹
            if grep -q "exit 0" files/99-default-settings; then
              sed -i '/exit 0/i\# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===' files/99-default-settings
              sed -i '/# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===/r /tmp/custom_settings' files/99-default-settings
              sed -i '/# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===/d' files/99-default-settings
              echo "âœ“ ä½¿ç”¨sedæ–¹å¼ä¿®æ”¹æˆåŠŸ"
            else
              cat /tmp/custom_settings >> files/99-default-settings
              echo "exit 0" >> files/99-default-settings
              echo "âœ“ åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ è‡ªå®šä¹‰è®¾ç½®"
            fi
            rm -f /tmp/custom_settings
          else
            echo "â„¹ æ–‡ä»¶å·²åŒ…å«è‡ªå®šä¹‰è®¾ç½®ï¼Œè·³è¿‡ä¿®æ”¹"
          fi
          chmod +x files/99-default-settings
        else
          echo "âš  æœªæ‰¾åˆ°99-default-settingsæ–‡ä»¶ï¼Œåˆ—å‡ºfilesç›®å½•å†…å®¹:"
          ls -la files/ 2>/dev/null || echo "filesç›®å½•ä¸å­˜åœ¨"
        fi
        echo "=== ä¿®æ”¹å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶å†…å®¹ ==="
        if [ -f "files/99-default-settings" ]; then
          echo "æ–‡ä»¶å†…å®¹:"
          cat files/99-default-settings
        fi
      run: |
        cd openwrt
        mkdir -p ./artifact/firmware ./artifact/package ./artifact/buildinfo

        find ./bin/targets/ -type d -name "packages" -exec rm -rf {} +
        find ./bin/targets/ -type f -exec cp -t ./artifact/firmware/ {} +
        find ./bin/packages/ -type f -name "*.ipk" -exec cp -t ./artifact/package/ {} +
        find ./bin/targets/ -type f \( -name "*.buildinfo" -o -name "*.manifest" \) -exec cp -t ./artifact/buildinfo/ {} +

        cp -f ./.config ./artifact/buildinfo/${{ env.Firmware_Name }}.info
        cp -f ./.config ./artifact/firmware/${{ env.Firmware_Name }}.info
        cp -f ./feeds.conf.default ./artifact/buildinfo/

        cd artifact/firmware/
        rename "s/openwrt/${{ env.Firmware_Name }}/" * || true

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d.%H.%M")-${{ env.Firmware_Name }}" >> $GITHUB_OUTPUT
        echo "release_date=$(date +"%Y.%m.%d.%H.%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "
        â° ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_TIME1 }}
        
        ğŸˆ å›ºä»¶ç‰ˆæœ¬ï¼šImmortalWrt Custom Build
        
        ğŸ–¥ ç®¡ç†åœ°å€ï¼š192.168.10.1 
        
        ğŸŒ´ ç”¨æˆ·åï¼šroot
        
        ğŸ›  å¯†ç ï¼špassword
        
        ğŸ“ è‡ªå®šä¹‰åŠŸèƒ½ï¼š
        - ä¸­æ–‡ç•Œé¢
        - è‡ªå®šä¹‰IPåœ°å€(192.168.10.1)
        - ä¼˜åŒ–æ—¶åŒºè®¾ç½®
        - é¢„è®¾WiFié…ç½®
        - DHCPèŒƒå›´: 192.168.10.100-250
        " >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
      with:
        name: ${{ steps.tag.outputs.release_date }} ${{ env.Firmware_Name }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: openwrt/artifact/firmware/*
