#
# <https://github.com/KFERMercer/OpenWrt-CI>
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
# chmod +x /etc/init.d/netspeedtest

name: immortalwrt-all

on:
  # schedule:
  # - cron: '0 22 * * *'
  # release:
  #   types: [ published ]

  watch:
    types: [ started ]

  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: false
        type: boolean

      CACHE_BUILD:
        description: 'ç¼“å­˜åŠ é€Ÿ'
        required: true
        default: true
        type: boolean

      UPLOAD_FIRMWARE:
        description: 'æ˜¯å¦ä¸Šä¼ å›ºä»¶'
        required: true
        default: true
        type: boolean

      UPLOAD_BUILDINFO:
        description: 'æ˜¯å¦ä¸Šä¼ é…ç½®æ–‡ä»¶'
        required: true
        default: true
        type: boolean

      UPLOAD_PACKAGE:
        description: 'æ˜¯å¦ä¸Šä¼ æ’ä»¶'
        required: true
        default: true
        type: boolean

      UPLOAD_RELEASE:
        description: 'æ˜¯å¦å‘å¸ƒåˆ° Releases'
        required: true
        default: true
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10

  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: config/immortalwrt.info
  Firmware_Name: immortalwrt-all
  DIY_P1_SH: smpackage/immortalwrt-all-1.sh
  DIY_P2_SH: smpackage/immortalwrt-all-2.sh
  PATCH_MAKEFILE: smpackage/patch1.patch
  CUSTOM_SETTINGS: smpackage/99-my-default-settings
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_BUILDINFO: true
  UPLOAD_PACKAGE: true
  UPLOAD_RELEASE: true
  GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
  TZ: Asia/Shanghai

jobs:
  build_openwrt:
    name: immortalwrt-all
    runs-on: Ubuntu-22.04

    steps:
    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
      uses: endersonmenezes/free-disk-space@v2
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/share/glade* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell"
        testing: false

    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev rename
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
      id: date
      run: |
        sudo timedatectl set-timezone "$TZ"
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
        echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
        echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´..."
        START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
        echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV

    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@v4

    - name: ä¸‹è½½æºä»£ç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL openwrt
        cd openwrt
        if [ -n "$REPO_TAG" ]; then
          git fetch --tags
          git checkout $REPO_TAG
        else
          git checkout $REPO_BRANCH
        fi
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: ç¼“å­˜
      uses: klever1988/cachewrtbuild@main
      if: github.event.inputs.CACHE_BUILD == 'true'
      with:
        ccache: 'true'
        mixkey: '${{ env.Firmware_Name }}'
        prefix: ${{ github.workspace }}/openwrt

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬1
      run: |
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°æº
      run: cd openwrt && ./scripts/feeds update -a

    - name: å®‰è£…æºå’Œåº”ç”¨è¡¥ä¸
      run: |
        cd openwrt
        ./scripts/feeds install -a

        echo "=== å¼€å§‹åº”ç”¨è‡ªå®šä¹‰è¡¥ä¸å’Œè®¾ç½® ==="

        # æ£€æŸ¥default-settingsç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "package/emortal/default-settings" ]; then
          echo "é”™è¯¯: default-settingsç›®å½•ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾å¯èƒ½çš„è·¯å¾„..."
          find package/ -name "*default*" -type d
          # å°è¯•å…¶ä»–å¯èƒ½çš„è·¯å¾„
          if [ -d "package/base-files" ]; then
            echo "ä½¿ç”¨base-filesä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ"
            DEFAULT_SETTINGS_PATH="package/base-files"
          else
            echo "æœªæ‰¾åˆ°åˆé€‚çš„é»˜è®¤è®¾ç½®ç›®å½•"
            exit 1
          fi
        else
          DEFAULT_SETTINGS_PATH="package/emortal/default-settings"
        fi

        cd $DEFAULT_SETTINGS_PATH
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la

        # åº”ç”¨Makefileè¡¥ä¸ï¼ˆå¦‚æœå­˜åœ¨ä¸”é€‚ç”¨ï¼‰
        if [ -e "$GITHUB_WORKSPACE/$PATCH_MAKEFILE" ] && [ -f "Makefile" ]; then
          echo "å‡†å¤‡åº”ç”¨Makefileè¡¥ä¸: $PATCH_MAKEFILE"
          cp "$GITHUB_WORKSPACE/$PATCH_MAKEFILE" ./patch1.patch
          
          echo "è¡¥ä¸å†…å®¹é¢„è§ˆ:"
          head -20 patch1.patch
          
          # å°è¯•åº”ç”¨è¡¥ä¸
          if patch --dry-run -p1 < patch1.patch >/dev/null 2>&1; then
            echo "âœ“ è¡¥ä¸æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹åº”ç”¨"
            patch -p1 < patch1.patch
            echo "âœ“ Makefileè¡¥ä¸åº”ç”¨æˆåŠŸ"
          else
            echo "âš  è¡¥ä¸æ— æ³•ç›´æ¥åº”ç”¨ï¼Œå°è¯•å…¶ä»–æ–¹å¼"
            echo "è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸå§‹é…ç½®"
          fi
        fi

        # å¤„ç†è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶
        if [ -e "$GITHUB_WORKSPACE/$CUSTOM_SETTINGS" ]; then
          echo "æ·»åŠ è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶: $CUSTOM_SETTINGS"
          
          # ç¡®ä¿filesç›®å½•å­˜åœ¨
          mkdir -p files
          
          # å¤åˆ¶è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶
          cp "$GITHUB_WORKSPACE/$CUSTOM_SETTINGS" files/99-my-default-settings
          chmod +x files/99-my-default-settings
          
          echo "âœ“ è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶å·²æ·»åŠ "
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -15 files/99-my-default-settings
          
          # å¦‚æœæ²¡æœ‰æˆåŠŸåº”ç”¨Makefileè¡¥ä¸ï¼Œåˆ™ç›´æ¥æ›¿æ¢é»˜è®¤è®¾ç½®æ–‡ä»¶
          # if [ -f "files/99-default-settings" ]; then
          #   echo "å¤‡ä»½å¹¶æ›¿æ¢åŸå§‹é»˜è®¤è®¾ç½®æ–‡ä»¶"
          #   cp files/99-default-settings files/99-default-settings.bak
          #   cp files/99-my-default-settings files/99-default-settings
          #   echo "âœ“ å·²æ›¿æ¢åŸå§‹é»˜è®¤è®¾ç½®æ–‡ä»¶"
          # fi
        else
          echo "â„¹ æœªæ‰¾åˆ°è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶: $CUSTOM_SETTINGS"
        fi

        echo "=== æœ€ç»ˆæ–‡ä»¶çŠ¶æ€ ==="
        echo "filesç›®å½•å†…å®¹:"
        ls -la files/ || echo "filesç›®å½•ä¸å­˜åœ¨"

        if [ -f "files/99-my-default-settings" ]; then
          echo "âœ“ è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶å­˜åœ¨"
        fi

        if [ -f "files/99-default-settings" ]; then
          echo "âœ“ é»˜è®¤è®¾ç½®æ–‡ä»¶å­˜åœ¨"
          echo "é»˜è®¤è®¾ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -10 files/99-default-settings
        fi

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬2
      run: |
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: SSHè¿æ¥åˆ°Actions
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false') || contains(github.event.action, 'ssh')
      uses: P3TERX/ssh2actions@v1.0.0

    - name: è¾“å‡ºç¼–è¯‘ä¿¡æ¯
      run: |
        cd openwrt
        echo " ç³»ç»Ÿç©ºé—´      ç±»å‹   æ€»æ•°  å·²ç”¨  å¯ç”¨ ä½¿ç”¨ç‡"
        df -hT $PWD
        echo
        echo "=========================================="
        echo

        # æ˜¾ç¤ºå·²é€‰æ’ä»¶åˆ—è¡¨
        grep -i CONFIG_PACKAGE_luci-app .config | grep -v \# > Plug-in
        grep -i CONFIG_PACKAGE_luci-theme .config | grep -v \# >> Plug-in
        sed -i '/INCLUDE/d' Plug-in > /dev/null 2>&1
        sed -i 's/CONFIG_PACKAGE_/ã€/g' Plug-in
        sed -i '/Transparent_Proxy/d' Plug-in > /dev/null 2>&1
        sed -i '/qbittorrent-simple_dynamic/d' Plug-in > /dev/null 2>&1
        sed -i 's/=y/\ /g' Plug-in
        awk '$0=NR$0' Plug-in > Plug-2
        awk '{print "	" $0}' Plug-2 > Plug-in

        echo "å·²é€‰æ’ä»¶åˆ—è¡¨"
        cat Plug-in
        rm -rf {Plug-in,Plug-2}
        echo
        echo "=========================================="

    - name: ä¸‹è½½å›ºä»¶åŒ…
      id: package
      if: (!cancelled())
      run: |
        cd openwrt
        make defconfig
        make download -j$(($(nproc)+1))
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: å°†ç”Ÿæˆçš„.configæ–‡ä»¶å¤åˆ¶åˆ°configæ–‡ä»¶å¤¹
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        mkdir -p config
        cp openwrt/.config config/immortalwrt.info

    - name: æäº¤.configæ–‡ä»¶åˆ°æºç åº“
      if: steps.compile.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ”¹
        if ! git diff --quiet -- config/immortalwrt.info; then
          # å…ˆè·å–æœ€æ–°çš„è¿œç¨‹çŠ¶æ€
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }} || git reset --hard origin/${{ github.ref_name }}
          
          # é‡æ–°å¤åˆ¶æ›´æ–°çš„é…ç½®æ–‡ä»¶
          cp openwrt/.config config/immortalwrt.info
          
          # æäº¤æ›´æ”¹
          git add config/immortalwrt.info
          git commit -m "è‡ªåŠ¨æ›´æ–°ç¼–è¯‘é…ç½® [$(date '+%Y-%m-%d %H:%M:%S')]" || echo "æ— éœ€æäº¤"
          git push origin ${{ github.ref_name }} || echo "æ¨é€å¤±è´¥ï¼Œè·³è¿‡"
        else
          echo ".configæ–‡ä»¶æ²¡æœ‰æ›´æ”¹ï¼Œæ— éœ€æäº¤ã€‚"
        fi

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: artifact
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt

        echo "=== è°ƒè¯•ï¼šæ£€æŸ¥ç¼–è¯‘è¾“å‡ºç»“æ„ ==="
        echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
        ls -la

        echo "binç›®å½•ç»“æ„ï¼š"
        if [ -d "bin" ]; then
          find bin/ -type f | head -20
          echo "binç›®å½•æ–‡ä»¶æ€»æ•°ï¼š$(find bin/ -type f | wc -l)"
        else
          echo "binç›®å½•ä¸å­˜åœ¨"
        fi

        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p ./artifact/firmware ./artifact/package ./artifact/buildinfo

        echo "=== å¼€å§‹æ•´ç†æ–‡ä»¶ ==="

        # å¤„ç†å›ºä»¶æ–‡ä»¶
        if [ -d "bin/targets" ]; then
          echo "å¤„ç†å›ºä»¶æ–‡ä»¶..."
          find bin/targets/ -type f | while read -r file; do
            echo "å¤åˆ¶å›ºä»¶æ–‡ä»¶: $file"
            cp "$file" ./artifact/firmware/ 2>/dev/null || echo "å¤±è´¥: $file"
          done
          echo "å›ºä»¶æ–‡ä»¶å¤åˆ¶å®Œæˆï¼Œå…± $(ls artifact/firmware/ | wc -l) ä¸ªæ–‡ä»¶"
        else
          echo "è­¦å‘Š: bin/targets ç›®å½•ä¸å­˜åœ¨"
        fi

        # å¤„ç†IPKåŒ…
        if [ -d "bin/packages" ]; then
          echo "å¤„ç†IPKåŒ…..."
          find bin/packages/ -name "*.ipk" | while read -r file; do
            echo "å¤åˆ¶IPKåŒ…: $file"
            cp "$file" ./artifact/package/ 2>/dev/null || echo "å¤±è´¥: $file"
          done
          echo "IPKåŒ…å¤åˆ¶å®Œæˆï¼Œå…± $(ls artifact/package/ | wc -l) ä¸ªæ–‡ä»¶"
        else
          echo "æç¤º: bin/packages ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡IPKåŒ…å¤„ç†"
        fi

        # å¤„ç†æ„å»ºä¿¡æ¯æ–‡ä»¶
        echo "å¤„ç†æ„å»ºä¿¡æ¯æ–‡ä»¶..."
        buildinfo_count=0

        # æŸ¥æ‰¾å¹¶å¤åˆ¶ .buildinfo æ–‡ä»¶
        if find bin/targets/ -name "*.buildinfo" 2>/dev/null | grep -q .; then
          find bin/targets/ -name "*.buildinfo" | while read -r file; do
            echo "å¤åˆ¶buildinfo: $file"
            cp "$file" ./artifact/buildinfo/
            buildinfo_count=$((buildinfo_count + 1))
          done
        else
          echo "æœªæ‰¾åˆ° .buildinfo æ–‡ä»¶"
        fi

        # æŸ¥æ‰¾å¹¶å¤åˆ¶ .manifest æ–‡ä»¶
        if find bin/targets/ -name "*.manifest" 2>/dev/null | grep -q .; then
          find bin/targets/ -name "*.manifest" | while read -r file; do
            echo "å¤åˆ¶manifest: $file"
            cp "$file" ./artifact/buildinfo/
            buildinfo_count=$((buildinfo_count + 1))
          done
        else
          echo "æœªæ‰¾åˆ° .manifest æ–‡ä»¶"
        fi

        # å¤åˆ¶é…ç½®æ–‡ä»¶
        echo "å¤åˆ¶é…ç½®æ–‡ä»¶..."
        if [ -f ".config" ]; then
          cp .config ./artifact/buildinfo/${{ env.Firmware_Name }}.info
          cp .config ./artifact/firmware/${{ env.Firmware_Name }}.info
          echo "å·²å¤åˆ¶ .config æ–‡ä»¶"
        else
          echo "è­¦å‘Š: .config æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        if [ -f "feeds.conf.default" ]; then
          cp feeds.conf.default ./artifact/buildinfo/
          echo "å·²å¤åˆ¶ feeds.conf.default"
        else
          echo "è­¦å‘Š: feeds.conf.default ä¸å­˜åœ¨"
        fi
          
          # åˆ›å»ºç¼–è¯‘ä¿¡æ¯æ–‡ä»¶ï¼ˆç¡®ä¿buildinfoç›®å½•ä¸ä¸ºç©ºï¼‰
          cat > ./artifact/buildinfo/build-summary.txt << EOF
        ç¼–è¯‘æ‘˜è¦
        ========
        ç¼–è¯‘æ—¶é—´: $(date)
        ç›®æ ‡è®¾å¤‡: ${{ env.DEVICE_NAME }}
        å›ºä»¶åç§°: ${{ env.Firmware_Name }}
        æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        ç¼–è¯‘ä¸»æœº: $(hostname)

        æ–‡ä»¶ç»Ÿè®¡:
        å›ºä»¶æ–‡ä»¶: $(ls artifact/firmware/ | wc -l) ä¸ª
        IPKåŒ…æ–‡ä»¶: $(ls artifact/package/ | wc -l) ä¸ª
        æ„å»ºä¿¡æ¯: $(ls artifact/buildinfo/ | wc -l) ä¸ª

        ç¼–è¯‘å®ŒæˆçŠ¶æ€: æˆåŠŸ
        EOF
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶
          cd artifact/firmware/
          for file in *openwrt*; do
            if [ -f "$file" ]; then
              new_name=$(echo "$file" | sed "s/openwrt/${{ env.Firmware_Name }}/")
              mv "$file" "$new_name" 2>/dev/null || echo "é‡å‘½åå¤±è´¥: $file"
            fi
          done
          
          cd ../..
          
          echo "=== æœ€ç»ˆæ–‡ä»¶ç»Ÿè®¡ ==="
          echo "å›ºä»¶ç›®å½•æ–‡ä»¶æ•°: $(ls artifact/firmware/ | wc -l)"
          echo "åŒ…ç›®å½•æ–‡ä»¶æ•°: $(ls artifact/package/ | wc -l)"
          echo "æ„å»ºä¿¡æ¯ç›®å½•æ–‡ä»¶æ•°: $(ls artifact/buildinfo/ | wc -l)"
          
          echo "æ„å»ºä¿¡æ¯ç›®å½•å†…å®¹:"
          ls -la artifact/buildinfo/
          
          echo "å›ºä»¶ç›®å½•å†…å®¹:"
          ls -la artifact/firmware/

    - name: ä¸Šä¼ å›ºä»¶
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_firmware_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/artifact/firmware/
        if-no-files-found: error
        retention-days: 30
        compression-level: 6
        overwrite: true

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BUILDINFO == 'true' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_buildinfo${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/artifact/buildinfo/
        if-no-files-found: warn
        retention-days: 30
        compression-level: 6
        overwrite: true

    - name: ä¸Šä¼ æ’ä»¶
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_PACKAGE == 'true' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_package${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/artifact/package/
        if-no-files-found: warn
        retention-days: 30
        compression-level: 6
        overwrite: true

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d.%H.%M")-${{ env.Firmware_Name }}" >> $GITHUB_OUTPUT
        echo "release_date=$(date +"%Y.%m.%d.%H.%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "
        â° ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_TIME1 }}

        ğŸˆ å›ºä»¶ç‰ˆæœ¬ï¼šImmortalWrt Custom

        ğŸ–¥ ç®¡ç†åœ°å€ï¼š192.168.10.1 

        ğŸŒ´ ç”¨æˆ·åï¼šroot

        ğŸ›  å¯†ç ï¼špassword

        ğŸ“ è‡ªå®šä¹‰åŠŸèƒ½ï¼š
        - ä¸­æ–‡ç•Œé¢
        - è‡ªå®šä¹‰IPåœ°å€
        - ä¼˜åŒ–æ—¶åŒºè®¾ç½®
        - é¢„è®¾WiFié…ç½®
        " >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
      with:
        name: ${{ steps.tag.outputs.release_date }} ${{ env.Firmware_Name }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: openwrt/artifact/firmware/*

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.3.3
      continue-on-error: true
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 60
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
