name: immortalwrt-r3s

on:
  watch:
    types: [ started ]
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: false
        type: boolean
      CACHE_BUILD:
        description: 'ç¼“å­˜åŠ é€Ÿ'
        required: true
        default: true
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'æ˜¯å¦ä¸Šä¼ å›ºä»¶'
        required: true
        default: true
        type: boolean
      UPLOAD_BUILDINFO:
        description: 'æ˜¯å¦ä¸Šä¼ é…ç½®æ–‡ä»¶'
        required: true
        default: true
        type: boolean
      UPLOAD_PACKAGE:
        description: 'æ˜¯å¦ä¸Šä¼ æ’ä»¶'
        required: true
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'æ˜¯å¦å‘å¸ƒåˆ° Releases'
        required: true
        default: true
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: config/immortalwrt.info
  Firmware_Name: immortalwrt-all
  DIY_P1_SH: smpackage/immortalwrt-all-1.sh
  DIY_P2_SH: smpackage/immortalwrt-all-2.sh
  SETTINGS_PATCH: smpackage/settings.patch
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_BUILDINFO: true
  UPLOAD_PACKAGE: true
  UPLOAD_RELEASE: true
  GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
  TZ: Asia/Shanghai

jobs:
  build_openwrt:
    name: immortalwrt-all
    runs-on: Ubuntu-22.04
    permissions:
      contents: write # ç”¨äºåˆ›å»ºrelease
      packages: read # ç”¨äºè¯»å–åŒ…
      id-token: write # ç”¨äºèº«ä»½éªŒè¯
      actions: write # ç”¨äºç®¡ç†å·¥ä½œæµ
      deployments: write # ç”¨äºéƒ¨ç½²
      issues: write # ç”¨äºåˆ›å»ºissue
      discussions: write # ç”¨äºåˆ›å»ºè®¨è®º

    steps:
    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
      uses: endersonmenezes/free-disk-space@v2
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/share/glade* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell"
        testing: false

    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev rename
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
      id: date
      run: |
        sudo timedatectl set-timezone "$TZ"
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
        echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
        echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
        START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
        echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV

    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@v4

    - name: ä¸‹è½½æºä»£ç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL openwrt
        cd openwrt
        if [ -n "$REPO_TAG" ]; then
          git fetch --tags
          git checkout $REPO_TAG
        else
          git checkout $REPO_BRANCH
        fi
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: ç¼“å­˜
      uses: klever1988/cachewrtbuild@main
      if: github.event.inputs.CACHE_BUILD == 'true'
      with:
        ccache: 'true'
        mixkey: '${{ env.Firmware_Name }}'
        prefix: ${{ github.workspace }}/openwrt

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬1
      run: |
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°æº
      run: cd openwrt && ./scripts/feeds update -a

    - name: å®‰è£…æºå’Œä¿®æ”¹é»˜è®¤è®¾ç½®
      run: |
        cd openwrt
        ./scripts/feeds install -a

        echo "=== å¼€å§‹ä¿®æ”¹é»˜è®¤è®¾ç½®æ–‡ä»¶ ==="

        # æŸ¥æ‰¾default-settingsç›®å½•
        DEFAULT_SETTINGS_PATH=""
        if [ -d "package/emortal/default-settings" ]; then
          DEFAULT_SETTINGS_PATH="package/emortal/default-settings"
        elif [ -d "package/lean/default-settings" ]; then
          DEFAULT_SETTINGS_PATH="package/lean/default-settings"
        else
          echo "æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„default-settingsç›®å½•:"
          find package/ -name "*default*" -type d
          DEFAULT_SETTINGS_PATH=$(find package/ -name "*default*" -type d | head -1)
        fi

        if [ -z "$DEFAULT_SETTINGS_PATH" ]; then
          echo "é”™è¯¯: æœªæ‰¾åˆ°default-settingsç›®å½•"
          exit 1
        fi

        echo "ä½¿ç”¨ç›®å½•: $DEFAULT_SETTINGS_PATH"
        cd $DEFAULT_SETTINGS_PATH

        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨99-default-settingsæ–‡ä»¶
        if [ -f "files/99-default-settings" ]; then
          echo "âœ“ æ‰¾åˆ°99-default-settingsæ–‡ä»¶"
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp files/99-default-settings files/99-default-settings.bak
          echo "âœ“ å·²å¤‡ä»½åŸæ–‡ä»¶"
          
          # æ–¹æ³•1: ä½¿ç”¨patchæ–¹å¼ä¿®æ”¹ï¼ˆå¦‚æœå­˜åœ¨patchæ–‡ä»¶ï¼‰
          if [ -e "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ]; then
            echo "å°è¯•ä½¿ç”¨patchæ–¹å¼ä¿®æ”¹..."
            cp "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ./settings.patch
            
            if patch --dry-run -p1 < settings.patch >/dev/null 2>&1; then
              patch -p1 < settings.patch
              echo "âœ“ patchæ–¹å¼ä¿®æ”¹æˆåŠŸ"
            else
              echo "âš  patchæ–¹å¼å¤±è´¥ï¼Œä½¿ç”¨sedæ–¹å¼ä¿®æ”¹"
              # æ¢å¤å¤‡ä»½æ–‡ä»¶
              cp files/99-default-settings.bak files/99-default-settings
            fi
          fi
          
          # æ–¹æ³•2: ä½¿ç”¨sedç›´æ¥åœ¨exit 0ä¹‹å‰æ’å…¥å†…å®¹
          if ! grep -q "ImmortalWrt-Custom" files/99-default-settings; then
            echo "ä½¿ç”¨sedæ–¹å¼æ·»åŠ è‡ªå®šä¹‰è®¾ç½®..."
            
            # åˆ›å»ºä¸´æ—¶çš„è‡ªå®šä¹‰è®¾ç½®å†…å®¹
            if [ -f "$GITHUB_WORKSPACE/$SETTINGS_PATCH" ]; then
              echo "ä½¿ç”¨ $SETTINGS_PATCH æ–‡ä»¶è¿›è¡Œä¿®æ”¹"
              cat "$GITHUB_WORKSPACE/$SETTINGS_PATCH" > /tmp/custom_settings
            else
              echo "$SETTINGS_PATCH ä¸å­˜åœ¨ï¼Œé…ç½®å¤±è´¥"
              exit 1
            fi
            
            # åœ¨exit 0ä¹‹å‰æ’å…¥è‡ªå®šä¹‰å†…å®¹
            if grep -q "exit 0" files/99-default-settings; then
              # æ‰¾åˆ°exit 0çš„è¡Œå·ï¼Œåœ¨å…¶å‰é¢æ’å…¥å†…å®¹
              sed -i '/exit 0/i\
              # === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===' files/99-default-settings
              
              # åœ¨æ ‡è®°è¡Œåæ’å…¥å®é™…å†…å®¹
              sed -i '/# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===/r /tmp/custom_settings' files/99-default-settings
              
              # åˆ é™¤æ ‡è®°è¡Œ
              sed -i '/# === æ’å…¥è‡ªå®šä¹‰è®¾ç½® ===/d' files/99-default-settings
              
              echo "âœ“ ä½¿ç”¨sedæ–¹å¼ä¿®æ”¹æˆåŠŸ"
            else
              # å¦‚æœæ²¡æœ‰exit 0ï¼Œç›´æ¥åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ 
              cat /tmp/custom_settings >> files/99-default-settings
              echo "exit 0" >> files/99-default-settings
              echo "âœ“ åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ è‡ªå®šä¹‰è®¾ç½®"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/custom_settings
          else
            echo "â„¹ æ–‡ä»¶å·²åŒ…å«è‡ªå®šä¹‰è®¾ç½®ï¼Œè·³è¿‡ä¿®æ”¹"
          fi
          
          # ç¡®ä¿æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          chmod +x files/99-default-settings
          
        else
          echo "âš  æœªæ‰¾åˆ°99-default-settingsæ–‡ä»¶ï¼Œåˆ—å‡ºfilesç›®å½•å†…å®¹:"
          ls -la files/ 2>/dev/null || echo "filesç›®å½•ä¸å­˜åœ¨"
        fi

        echo "=== ä¿®æ”¹å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶å†…å®¹ ==="
        if [ -f "files/99-default-settings" ]; then
          echo "æ–‡ä»¶å†…å®¹:"
          cat files/99-default-settings
        fi

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬2
      run: |
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: SSHè¿æ¥åˆ°Actions
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false') || contains(github.event.action, 'ssh')
      uses: P3TERX/ssh2actions@v1.0.0

    - name: è¾“å‡ºç¼–è¯‘ä¿¡æ¯
      run: |
        cd openwrt
        echo " ç³»ç»Ÿç©ºé—´      ç±»å‹   æ€»æ•°  å·²ç”¨  å¯ç”¨ ä½¿ç”¨ç‡"
        df -hT $PWD
        echo
        echo "=========================================="

        # æ˜¾ç¤ºè‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶çŠ¶æ€
        echo "æ£€æŸ¥è‡ªå®šä¹‰è®¾ç½®æ–‡ä»¶:"
        DEFAULT_SETTINGS_PATH=$(find package/ -name "*default*" -type d | head -1)
        if [ -n "$DEFAULT_SETTINGS_PATH" ] && [ -f "$DEFAULT_SETTINGS_PATH/files/99-default-settings" ]; then
          echo "âœ“ 99-default-settingsæ–‡ä»¶å­˜åœ¨"
          if grep -q "ImmortalWrt-Custom" "$DEFAULT_SETTINGS_PATH/files/99-default-settings"; then
            echo "âœ“ åŒ…å«è‡ªå®šä¹‰è®¾ç½®"
          else
            echo "âš  æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰è®¾ç½®"
          fi
        fi

        echo "=========================================="

        # æ˜¾ç¤ºå·²é€‰æ’ä»¶åˆ—è¡¨
        grep -i CONFIG_PACKAGE_luci-app .config | grep -v \# > Plug-in
        grep -i CONFIG_PACKAGE_luci-theme .config | grep -v \# >> Plug-in
        sed -i '/INCLUDE/d' Plug-in > /dev/null 2>&1
        sed -i 's/CONFIG_PACKAGE_/ã€/g' Plug-in
        sed -i 's/=y/\ /g' Plug-in
        awk '$0=NR$0' Plug-in > Plug-2
        awk '{print "	" $0}' Plug-2 > Plug-in

        echo "å·²é€‰æ’ä»¶åˆ—è¡¨"
        cat Plug-in
        rm -rf {Plug-in,Plug-2}

    - name: ä¸‹è½½å›ºä»¶åŒ…
      id: package
      if: (!cancelled())
      run: |
        cd openwrt
        make defconfig
        make download -j$(($(nproc)+1))
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo "CPUçº¿ç¨‹æ•°: $(nproc)"
        echo "å¯ç”¨å†…å­˜: $(free -h)"
        echo "å¼€å§‹æ—¶é—´: $(date "+%Y-%m-%d %H:%M:%S")"

        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        make defconfig
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s        echo "======================="
        echo "ç¼–è¯‘å®Œæˆæ—¶é—´: $(date "+%Y-%m-%d %H:%M:%S")"
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h

        echo "binç›®å½•å†…å®¹:"
        ls -la bin/

        if [ -d bin/packages ]; then
          echo "è½¯ä»¶åŒ…ç›®å½•å†…å®¹:"
          ls -la bin/packages/
        else
          echo "è­¦å‘Š: æ²¡æœ‰ç”Ÿæˆè½¯ä»¶åŒ…ç›®å½•"
        fi

        if [ -d bin/targets ]; then
          echo "ç›®æ ‡æ–‡ä»¶ç›®å½•å†…å®¹:"
          ls -la bin/targets/
        else
          echo "é”™è¯¯: æ²¡æœ‰ç”Ÿæˆå›ºä»¶ç›®å½•"
          exit 1
        fi

        echo "status=success" >> $GITHUB_OUTPUT

        # è·å–è®¾å¤‡åç§°
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: SSHè¿æ¥åˆ°Actionsè°ƒè¯•ç¼–è¯‘
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

    # åç»­çš„ä¸Šä¼ å’Œå‘å¸ƒæ­¥éª¤ä¿æŒä¸å˜...
    - name: ä¿å­˜é…ç½®æ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        echo "ä¿å­˜.configæ–‡ä»¶åˆ°ä»£ç åº“..."
        if [ -f .config ]; then
          cp -f .config $GITHUB_WORKSPACE/$CONFIG_FILE
          cd $GITHUB_WORKSPACE
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add $CONFIG_FILE
          git commit -m "bot: æ›´æ–°ç¼–è¯‘é…ç½® $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ“ é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤"
        else
          echo "âš  .configæ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: artifact
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        mkdir -p ./artifact/firmware ./artifact/package ./artifact/buildinfo

        # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
        [ -d ./bin/targets ] || { echo "è­¦å‘Š: bin/targets ç›®å½•ä¸å­˜åœ¨"; exit 1; }

        echo "=== å¼€å§‹æ•´ç†å›ºä»¶æ–‡ä»¶ ==="

        # å¤åˆ¶å®Œæˆåå†æ¸…ç†ä¸éœ€è¦çš„ç›®å½•
        if [ -d ./bin/targets ]; then
          echo "æ¸…ç† targets/packages ç›®å½•..."
          find ./bin/targets/ -type d -name "packages" -exec rm -rf {} + || true
        fi

        # é¦–å…ˆå¤åˆ¶æ‰€æœ‰æ–‡ä»¶
        if [ -d ./bin/targets ]; then
          echo "å¤åˆ¶å›ºä»¶æ–‡ä»¶..."
          find ./bin/targets/ -type f -exec cp -t ./artifact/firmware/ {} + || true
        fi



        # å¤åˆ¶IPKæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d ./bin/packages ]; then
          echo "å¤åˆ¶IPKåŒ…æ–‡ä»¶..."
          find ./bin/packages/ -type f -name "*.ipk" -exec cp -t ./artifact/package/ {} + || true
        else
          echo "æç¤º: bin/packages ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶IPKæ–‡ä»¶"
        fi

        # å¤åˆ¶buildinfoæ–‡ä»¶
        if [ -d ./bin/targets ]; then
          echo "å¤åˆ¶buildinfoæ–‡ä»¶..."
          find ./bin/targets/ -type f \( -name "*.buildinfo" -o -name "*.manifest" \) -exec cp -t ./artifact/buildinfo/ {} + || true
        fi

        # å¤åˆ¶é…ç½®æ–‡ä»¶
        echo "å¤åˆ¶é…ç½®æ–‡ä»¶..."
        [ -f ./.config ] && cp -f ./.config "./artifact/buildinfo/${{ env.Firmware_Name }}.info" || echo "è­¦å‘Š: .config æ–‡ä»¶ä¸å­˜åœ¨"
        [ -f ./.config ] && cp -f ./.config "./artifact/firmware/${{ env.Firmware_Name }}.info" || echo "è­¦å‘Š: .config æ–‡ä»¶ä¸å­˜åœ¨"
        [ -f ./feeds.conf.default ] && cp -f ./feeds.conf.default ./artifact/buildinfo/ || echo "è­¦å‘Š: feeds.conf.default ä¸å­˜åœ¨"

        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        if [ -d ./artifact/firmware ]; then
          echo "é‡å‘½åå›ºä»¶æ–‡ä»¶..."
          pushd ./artifact/firmware/
          rename "s/openwrt/${{ env.Firmware_Name }}/" * || true
          popd
        else
          echo "é”™è¯¯: artifact/firmware ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

        echo "=== å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆ ==="

        # æ˜¾ç¤ºæ•´ç†åçš„æ–‡ä»¶åˆ—è¡¨
        echo "å›ºä»¶ç›®å½•å†…å®¹:"
        ls -l ./artifact/firmware/
        echo "é…ç½®ç›®å½•å†…å®¹:"
        ls -l ./artifact/buildinfo/
        if [ -d ./artifact/package ]; then
          echo "è½¯ä»¶åŒ…ç›®å½•å†…å®¹:"
          ls -l ./artifact/package/
        fi

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d.%H.%M")-${{ env.Firmware_Name }}" >> $GITHUB_OUTPUT
        echo "release_date=$(date +"%Y.%m.%d.%H.%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "
        â° ç¼–è¯‘æ—¶é—´ï¼š$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")

        ğŸˆ å›ºä»¶ç‰ˆæœ¬ï¼šImmortalWrt Custom Build


        ğŸ–¥ ç®¡ç†åœ°å€ï¼š192.168.10.1\ 


        ğŸŒ´ ç”¨æˆ·åï¼šroot


        ğŸ›  å¯†ç ï¼špassword


        \udce6 æ–‡ä»¶è¯´æ˜ï¼š

        - firmware/: å›ºä»¶æ–‡ä»¶ç›®å½•

        - ipk_packages.tar.gz: IPKè½¯ä»¶åŒ…åˆé›†


        ğŸ“ è‡ªå®šä¹‰åŠŸèƒ½ï¼š

        - ä¸­æ–‡ç•Œé¢

        - è‡ªå®šä¹‰IPåœ°å€(192.168.10.1)

        - ä¼˜åŒ–æ—¶åŒºè®¾ç½®

        - é¢„è®¾WiFié…ç½®

        - DHCPèŒƒå›´: 192.168.10.100-250

        \" >> release.txt

        echo \"status=success\" >> $GITHUB_OUTPUT\n"

    - name: æ‰“åŒ…IPKæ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/artifact/package
        echo "åˆ›å»ºIPKå‹ç¼©åŒ…..."
        [ -d ./ ] && tar -czf ../ipk_packages.tar.gz ./ || echo "è­¦å‘Š: packageç›®å½•ä¸ºç©º"
        cd ..
        echo "IPKæ‰“åŒ…å®Œæˆ"

    - name: è‡ªåŠ¨å‘å¸ƒåˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        name: ${{ steps.tag.outputs.release_date }} ${{ env.Firmware_Name }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          openwrt/artifact/firmware/*
          openwrt/artifact/ipk_packages.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
