# === 自定义设置开始 ===

# 检查是否为保留配置的系统升级
if [ -f "/etc/backup/.sysupgrade" ] || [ -f "/etc/sysupgrade.conf" ]; then
    echo "检测到保留配置的系统升级，跳过默认设置..." > /tmp/custom_settings.log
    exit 0
fi

echo "应用自定义默认设置..."

# log potential errors
exec >/tmp/setup.log 2>&1
# wlan_name="ImmortalWrt"
# wlan_password="12345678"

root_password="password"
lan_ip_address="192.168.10.1"

if [ -n "$root_password" ]; then
  (echo "$root_password"; sleep 1; echo "$root_password") | passwd > /dev/null
fi

# 网络设置
# More options: https://openwrt.org/docs/guide-user/base-system/basic-networking
if [ -n "$lan_ip_address" ]; then
  uci set network.lan.ipaddr="$lan_ip_address"
  # DHCP设置
  uci set dhcp.lan.leasetime='2m'
fi

# Configure WLAN
# More options: https://openwrt.org/docs/guide-user/network/wifi/basic#wi-fi_interfaces
if [ -n "$wlan_name" -a -n "$wlan_password" -a ${#wlan_password} -ge 8 ]; then
  uci set wireless.@wifi-device[0].disabled='0'
  uci set wireless.@wifi-iface[0].disabled='0'
  uci set wireless.@wifi-iface[0].encryption='psk2'
  uci set wireless.@wifi-iface[0].ssid="$wlan_name"
  uci set wireless.@wifi-iface[0].key="$wlan_password"
fi


# 系统设置
uci set system.@system[0].hostname='ImmortalWrt'


# /etc/config/dhcp
uci add dhcp host # =cfg05fe63
uci set dhcp.@host[-1].name='DESKTOP-DR6M5VG'
uci set dhcp.@host[-1].ip='192.168.10.107'
uci add_list dhcp.@host[-1].mac='30:9C:23:E1:E3:72'
uci add dhcp host # =cfg06fe63
uci set dhcp.@host[-1].name='armbian'
uci set dhcp.@host[-1].ip='192.168.10.158'
uci add_list dhcp.@host[-1].mac='6A:CE:3B:D4:CB:8B'
uci add dhcp host # =cfg07fe63
uci set dhcp.@host[-1].name='WIN-LMSJ088AVIQ'
uci set dhcp.@host[-1].ip='192.168.10.180'
uci add_list dhcp.@host[-1].mac='7C:2B:E1:13:6E:83'
# /etc/config/zerotier
uci del zerotier.earth.enabled
uci del zerotier.earth.allow_managed
uci del zerotier.earth.allow_global
uci del zerotier.earth.allow_default
uci del zerotier.earth.allow_dns
uci del zerotier.earth.fw_allow_input
uci del zerotier.earth.fw_allow_forward
uci del zerotier.earth.fw_allow_masq
uci set zerotier.earth.id='d3ecf5726da3eeac'
uci del zerotier.global.enabled
uci set zerotier.earth.allow_global='1'
uci set zerotier.earth.allow_default='1'
uci set zerotier.earth.allow_dns='1'
uci set zerotier.earth.fw_allow_input='1'
uci set zerotier.earth.fw_allow_forward='1'
uci set zerotier.earth.fw_allow_masq='1'
uci set zerotier.global.enabled='1'

uci set vlmcsd.config.enabled='1'
uci set vlmcsd.config.auto_activate='1'
uci set vlmcsd.config.internet_access='1'


# 提交更改
uci commit

echo "自定义设置应用完成"
# === 自定义设置结束 ===
